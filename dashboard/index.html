<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stav poschodia</title>
<style>
  body{margin:0;background:#0b0d12;color:#e8ecf4;font-family:system-ui}
  .wrap{display:flex;gap:16px;padding:12px}
  .svgwrap{flex:1;position:relative;height:100vh;}
  .svgwrap svg{width:100%;height:auto;display:block;background:#fff}
  .room-done{ fill:#9aa0a6; fill-opacity:.35; }
  .panel{width:320px;background:#121521;border:1px solid #1e2230;
         border-radius:12px;padding:12px}
  .badge{display:inline-block;background:#1e2a44;border:1px solid #2d3e63;
         border-radius:999px;padding:2px 8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="svgwrap">
    <div id="svgHost"></div>
  </div>
  <div class="panel">
    <h3>Stav izieb</h3>
    <div id="status"></div>
  </div>
</div>

<!-- kniÅ¾nica na zoom/pan -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/svg-pan-zoom/3.6.1/svg-pan-zoom.min.js"></script>
<script>
// ðŸ”— DoplÅˆ svoju Apps Script URL (konÄiacu /exec)
const SHEET_API = 'https://script.google.com/macros/s/AKfycbws-p5Dcem0dwkXh_R3LG3p-y2DXLPQ6mYQ3YCQgg_1Ie7O_8JG02SmElSbk_Jof5GEDQ/exec';

// ak mÃ¡Å¡ floor.svg a mapping.json v root-e, pouÅ¾i ../
const SVG_URL = '../floor.svg';
const MAP_URL = 'mapping.json';

const svgHost   = document.getElementById('svgHost');
const statusBox = document.getElementById('status');

let mapping  = {};
let panzoom  = null;
let marksLayer = null;

async function loadSVGInline(url){
  const txt = await fetch(url).then(r=>r.text());
  svgHost.innerHTML = txt;
  const svg = svgHost.querySelector('svg');

  // vrstva pre znaÄky
  marksLayer = svg.querySelector('#rk-marks');
  if (!marksLayer) {
    marksLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
    marksLayer.setAttribute('id','rk-marks');
    svg.appendChild(marksLayer);
  }

  // inicializuj zoom/pan
  if (panzoom) panzoom.destroy();
  panzoom = svgPanZoom(svg, {
    zoomEnabled: true,
    controlIconsEnabled: true,
    fit: true,
    center: true,
    mouseWheelZoomEnabled: true,
  });

  return svg;
}

// âœ” / âœ— priamo do SVG
function placeTickSVG(room, circuit, done){
  const m = mapping[room]; if(!m) return;
  const p = m.circuits?.[circuit]; if(!p) return;

  const t = document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x', p.x);
  t.setAttribute('y', p.y);
  t.setAttribute('text-anchor','middle');
  t.setAttribute('dominant-baseline','central');
  t.setAttribute('font-size', 40); // uprav podÄ¾a mierky
  t.setAttribute('font-weight','900');
  t.setAttribute('fill', done ? '#31d158' : '#ff6666');
  t.textContent = done ? 'âœ”' : 'âœ—';
  marksLayer.appendChild(t);
}

// celÃ© miestnosti na sivo
function colorRoomIfAllDone(room, records){
  const m = mapping[room]; if(!m || !m.area_id) return;
  const needed = Object.keys(m.circuits||{});
  const doneSet = new Set(records.filter(r=>r.status==='hotovo').map(r=>r.circuit));
  const all = needed.length>0 && needed.every(k=>doneSet.has(k));
  const area = svgHost.querySelector('#'+m.area_id);
  if (area) area.classList.toggle('room-done', all);
}

async function refresh(){
  statusBox.innerHTML='';
  await loadSVGInline(SVG_URL);
  mapping = await fetch(MAP_URL).then(r=>r.json());
  const res = await fetch(SHEET_API).then(r=>r.json()).catch(()=>({items:[]}));
  const byRoom = {};
  (res.items||[]).forEach(i => (byRoom[i.room] ||= []).push(i));

  // vymaÅ¾ starÃ© âœ”
  while (marksLayer && marksLayer.firstChild) marksLayer.removeChild(marksLayer.firstChild);

  Object.keys(mapping).forEach(room=>{
    const items = byRoom[room]||[];
    const codes = Object.keys(mapping[room].circuits||{});
    codes.forEach(code=>{
      const rec = items.find(x=>x.circuit===code);
      placeTickSVG(room, code, !!rec && rec.status==='hotovo');
    });
    colorRoomIfAllDone(room, items);
    const done = items.filter(i=>i.status==='hotovo' && codes.includes(i.circuit)).length;
    const div = document.createElement('div');
    div.innerHTML = `<div class="badge">${room}: ${done}/${codes.length} hotovo</div>`;
    statusBox.appendChild(div);
  });
}

refresh();
setInterval(refresh, 8000);
</script>
</body>
</html>
