<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì∏ Fotky ‚Äì izba</title>
  <style>
    :root{
      --bg:#0b0d12; --card:#121521; --line:#1e2230; --text:#e8ecf4; --muted:#9aa0a6;
      --ok:#31d158; --err:#ff6b6b; --accent:#2d3e63;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    h1{margin:0 0 16px;font-weight:800;display:flex;gap:10px;align-items:center}
    h1 small{font-weight:600;opacity:.8}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
    label{display:block;margin:8px 0 6px;font-size:.95rem;opacity:.9}
    input[type=text]{width:100%;background:#0f1320;color:var(--text);border:1px solid var(--line);
      border-radius:10px;padding:10px 12px;outline:none}
    input[type=file]{width:100%}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
    .btn{display:inline-block;background:#1e2a44;border:1px solid var(--accent);color:#cde1ff;
      padding:10px 14px;border-radius:10px;text-decoration:none;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:10px;font-size:.95rem}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumb{background:#0f1320;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .thumb img{display:block;width:100%;height:140px;object-fit:cover}
    .thumb footer{padding:8px 10px;font-size:.8rem;color:var(--muted)}
    .pill{display:inline-block;background:#1e2a44;border:1px solid var(--accent);color:#cde1ff;
      padding:2px 8px;border-radius:999px;font-size:.8rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∏ Fotky ‚Äì <small id="roomTitle">‚Ä¶</small></h1>

    <div class="card">
      <div class="row">
        <div>
          <label for="wall">Stena (voliteƒæn√©, napr. EZI2_W1):</label>
          <input id="wall" type="text" inputmode="latin" placeholder="napr. EZI2_W1" />
        </div>
        <div>
          <label for="note">Pozn√°mka (voliteƒæn√©):</label>
          <input id="note" type="text" placeholder="kr√°tky popis ‚Äì napr. smer dr√°≈æky, 2x RJ45‚Ä¶" />
        </div>
      </div>

      <label for="photo">Fotka:</label>
      <input id="photo" type="file" accept="image/*" capture="environment" />

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button id="btnUpload" class="btn">Nahra≈•</button>
        <span id="msg" class="msg muted"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Gal√©ria</h3>
      <div id="gallery" class="grid"></div>
    </div>
  </div>

  <script>
    /************************************************************
     * NASTAVENIE ‚Äì dopl≈à Apps Script /exec URL
     ************************************************************/
    const PHOTOS_API = 'https://script.google.com/macros/s/AKfycbwg9D3PTS3q2xAlMoPJtP9yNy_n3NFarYc76AN4N_fertWiGTE5p3awR9WBuqGvtDFg/exec';

    /************************************************************
     * Pomocn√© prvky
     ************************************************************/
    const qs = new URLSearchParams(location.search);
    const room = qs.get('room') || 'UNKNOWN';
    document.getElementById('roomTitle').textContent = room;

    const elPhoto = document.getElementById('photo');
    const elWall  = document.getElementById('wall');
    const elNote  = document.getElementById('note');
    const elMsg   = document.getElementById('msg');
    const elBtn   = document.getElementById('btnUpload');
    const elGal   = document.getElementById('gallery');

    const msg = (t,kind='muted') => { elMsg.className = 'msg ' + kind; elMsg.textContent = t; };

    function addThumb(url, caption=''){
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `<img src="${url}" alt="">
        <footer>${caption ? `<span class="pill">${caption}</span>`:''}</footer>`;
      elGal.prepend(div);
    }

    /** preƒç√≠ta s√∫bor ako DataURL (base64) */
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = e => reject(e);
        fr.readAsDataURL(file);
      });
    }

    /************************************************************
     * Upload
     ************************************************************/
    elBtn.onclick = async () => {
      try{
        const file = elPhoto.files[0];
        if(!file){ msg('Vyber fotku.', 'err'); return; }

        msg('Konvertujem‚Ä¶');
        const dataUrl = await fileToDataURL(file);

        const payload = {
          room,
          wall: elWall.value.trim(),
          note: elNote.value.trim(),
          imageBase64: dataUrl,         // obsahuje "data:image/...;base64,AAAA"
          mimeType: file.type || 'image/jpeg',
          filename: `${room}_${(elWall.value.trim()||'WALL')}_${Date.now()}.jpg`,
          author: ''                     // voliteƒæne dopl≈à meno/ID
        };

        elBtn.disabled = true;
        msg('Nahr√°vam do cloudu‚Ä¶');

        const res = await fetch(PHOTOS_API, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        // oƒçak√°vame ƒçist√Ω JSON { ok:true, url, filename } z Apps Scriptu
        const j = await res.json().catch(()=> ({}));
        if(!j.ok){ throw new Error(j.error || 'Neplatn√° odpoveƒè servera'); }

        msg('‚úÖ Nahrat√©.', 'ok');
        addThumb(j.url, payload.wall || room);

        // reset
        elPhoto.value = '';
      }catch(err){
        console.error(err);
        msg('‚ùå ' + err.message, 'err');
      }finally{
        elBtn.disabled = false;
      }
    };

    /************************************************************
     * (Voliteƒæn√©) ‚Äì ak chce≈° ma≈• istotu, ≈æe je URL nastaven√°
     ************************************************************/
    if(!/^https:\/\/script\.google\.com\/macros\/s\/.+\/exec$/i.test(PHOTOS_API)){
      msg('Upozornenie: dopl≈à PHOTOS_API (Apps Script /exec URL).', 'err');
      elBtn.disabled = true;
    }
  </script>
</body>
</html>
