<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì∏ Fotky ‚Äì izba</title>
  <style>
    :root{
      --bg:#0b0d12; --card:#121521; --line:#1e2230; --text:#e8ecf4; --muted:#9aa0a6;
      --ok:#31d158; --err:#ff6b6b; --accent:#2d3e63;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    h1{margin:0 0 16px;font-weight:800;display:flex;gap:10px;align-items:center}
    h1 small{font-weight:600;opacity:.8}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
    label{display:block;margin:8px 0 6px;font-size:.95rem;opacity:.9}
    input[type=text]{width:100%;background:#0f1320;color:var(--text);border:1px solid var(--line);
      border-radius:10px;padding:10px 12px;outline:none}
    input[type=file]{width:100%}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
    .btn{display:inline-block;background:#1e2a44;border:1px solid var(--accent);color:#cde1ff;
      padding:10px 14px;border-radius:10px;text-decoration:none;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:10px;font-size:.95rem;min-height:1.4em}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumb{background:#0f1320;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .thumb img{display:block;width:100%;height:140px;object-fit:cover}
    .thumb footer{padding:8px 10px;font-size:.8rem;color:var(--muted);display:flex;justify-content:space-between}
    .pill{display:inline-block;background:#1e2a44;border:1px solid var(--accent);color:#cde1ff;
      padding:2px 8px;border-radius:999px;font-size:.8rem}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{font-size:.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì∏ Fotky ‚Äì <small id="roomTitle">‚Ä¶</small></h1>

    <div class="card">
      <div class="hint" id="health">Kontrolujem pripojenie‚Ä¶</div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="wall">Stena (voliteƒæn√©, napr. EZI2_W1):</label>
          <input id="wall" type="text" inputmode="latin" placeholder="napr. EZI2_W1" />
        </div>
        <div>
          <label for="note">Pozn√°mka (voliteƒæn√©):</label>
          <input id="note" type="text" placeholder="kr√°tky popis ‚Äì napr. smer dr√°≈æky, 2x RJ45‚Ä¶" />
        </div>
      </div>

      <label for="photo">Fotka:</label>
      <input id="photo" type="file" accept="image/*" capture="environment" />

      <div class="flex" style="margin-top:8px">
        <label class="hint">
          <input type="checkbox" id="resize" checked />
          Komprimova≈• na max. 1600 px (odpor√∫ƒçan√©)
        </label>
      </div>

      <div style="margin-top:12px" class="flex">
        <button id="btnUpload" class="btn">Nahra≈•</button>
        <span id="msg" class="msg muted"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Gal√©ria</h3>
      <div id="gallery" class="grid"></div>
    </div>
  </div>

  <script>
    /************************************************************
     * DOPL≈á tvoje Apps Script /exec URL
     ************************************************************/
    const PHOTOS_API = 'https://script.google.com/macros/s/AKfycby6Kt-JT6MqwRGjcOrZJw-Mgqn5lJHjFpxFzZc9at7jfluL9DWK9DjswkOath_tSxjJ/exec';

    /***************** Pomocn√© prvky a stav ********************/
    const qs    = new URLSearchParams(location.search);
    const room  = qs.get('room') || '';
    const preWall = qs.get('wall') || '';

    const elRoom = document.getElementById('roomTitle');
    const elPhoto= document.getElementById('photo');
    const elWall = document.getElementById('wall');
    const elNote = document.getElementById('note');
    const elMsg  = document.getElementById('msg');
    const elBtn  = document.getElementById('btnUpload');
    const elGal  = document.getElementById('gallery');
    const elHC   = document.getElementById('health');
    const elResize = document.getElementById('resize');

    elRoom.textContent = room || '‚Äî';
    if (preWall) elWall.value = preWall;

    function msg(t,kind='muted'){ elMsg.className='msg '+kind; elMsg.textContent=t; }
    function health(t,kind='muted'){ elHC.className='hint '+kind; elHC.textContent=t; }

    function addThumb(url, caption=''){
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `
        <img src="${url}" alt="">
        <footer>
          ${caption ? `<span class="pill">${caption}</span>`:''}
          <a class="hint" href="${url}" target="_blank">otvori≈•</a>
        </footer>`;
      elGal.prepend(div);
    }

    /** ƒç√≠tanie s√∫boru do ImageBitmap (r√Ωchle), potom kresba na canvas */
    async function resizeToDataURL(file, maxSize=1600){
      // ak kompresiu nechce≈°, pou≈æijeme p√¥vodn√Ω dataURL
      if (!elResize.checked) return await fileToDataURL(file);

      const bmp = await createImageBitmap(file);
      const scale = Math.min(1, maxSize/Math.max(bmp.width, bmp.height));
      const w = Math.round(bmp.width*scale), h = Math.round(bmp.height*scale);

      const cvs = document.createElement('canvas'); cvs.width=w; cvs.height=h;
      const ctx = cvs.getContext('2d');
      ctx.drawImage(bmp, 0, 0, w, h);
      const type = file.type || 'image/jpeg';
      const quality = type.includes('jpeg') ? 0.85 : 1.0;
      return cvs.toDataURL(type, quality);
    }
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.onerror=e=>reject(e);
        fr.readAsDataURL(file);
      });
    }

    /******************** Health-check (GET) *******************/
    (async function check(){
      try{
        if(!room){
          health('Ch√Ωba parameter ?room=‚Ä¶ ‚Äì upload je zak√°zan√Ω.', 'err');
          elBtn.disabled = true;
          return;
        }
        if(!/^https:\/\/script\.google\.com\/macros\/s\/.+\/exec$/i.test(PHOTOS_API)){
          health('Dopl≈à PHOTOS_API na tvoje Apps Script /exec.', 'err');
          elBtn.disabled = true;
          return;
        }
        const r = await fetch(PHOTOS_API, { cache:'no-store' });
        const j = await r.json().catch(()=>null);
        if(j && j.ok){
          health('Server OK ‚Äì m√¥≈æe≈° nahr√°va≈• ‚úÖ','ok');
        }else{
          health('Server odpovedal neplatne. Skontroluj nasadenie / opr√°vnenia.', 'err');
        }
      }catch(e){
        health('Server je nedostupn√Ω. Sk√∫s sie≈• / opr√°vnenia Web App.', 'err');
      }
    })();

    /************************ Upload ***************************/
    elBtn.onclick = async () => {
    try{
      const file = elPhoto.files[0];
      if(!file){ msg('Vyber fotku.', 'err'); return; }
      if(!room){ msg('Ch√Ωba ?room=‚Ä¶ v URL.', 'err'); return; }

      msg('Pripravujem fotku‚Ä¶');
      const dataUrl = await resizeToDataURL(file, 1600);

      const payload = {
        room,
        wall: elWall.value.trim(),
        note: elNote.value.trim(),
        imageBase64: dataUrl,               // "data:image/...;base64,...."
        mimeType: file.type || 'image/jpeg',
        filename: `${room}_${(elWall.value.trim()||'WALL')}_${Date.now()}.jpg`,
        author: ''
      };

      elBtn.disabled = true;
      msg('Nahr√°vam na server‚Ä¶');

      // ‚¨áÔ∏è kƒæ√∫ƒçov√° zmena ‚Äì ≈æiadne headers
      const res = await fetch(PHOTOS_API, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      if (!res.ok){
        const text = await res.text();
        throw new Error(`HTTP ${res.status} ‚Äì ${text.slice(0,120)}`);
      }

      const j = await res.json().catch(()=>{ throw new Error('Server nevr√°til JSON'); });
      if(!j.ok) throw new Error(j.error || 'Nezn√°ma chyba servera');

      msg('‚úÖ Nahrat√©.', 'ok');
      addThumb(j.url, payload.wall || room);
      elPhoto.value = '';
    }catch(err){
      console.error(err);
      msg('‚ùå ' + err.message, 'err');
    }finally{
      elBtn.disabled = false;
    }
  };
  </script>
</body>
</html>





