<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fotky miestnosti</title>
<style>
  body{margin:0;background:#0b0d12;color:#e8ecf4;font-family:system-ui}
  .wrap{max-width:760px;margin:0 auto;padding:20px}
  h1{font-size:20px;margin:0 0 12px}
  .card{background:#121521;border:1px solid #1e2230;border-radius:12px;padding:14px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,button{background:#0f1320;color:#e8ecf4;border:1px solid #2a3350;border-radius:8px;padding:10px}
  button{cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:10px}
  .thumb{background:#111726;border:1px solid #20283c;border-radius:8px;padding:8px}
  .thumb img{width:100%;height:120px;object-fit:cover;border-radius:6px}
  .muted{opacity:.75;font-size:13px}
  .ok{color:#31d158} .err{color:#ff6666}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì∏ Fotky ‚Äì <span id="roomName"></span></h1>

  <div class="card">
    <div class="row">
      <label for="wall">Stena (voliteƒæn√©):</label>
      <input id="wall" placeholder="napr. EZI2_W1">
    </div>

    <div class="row">
      <!-- capture="environment" zapne zadn√∫ kameru v mobile -->
      <input id="photo" type="file" accept="image/*" capture="environment">
      <button id="uploadBtn">Nahra≈•</button>
    </div>

    <div id="msg" class="muted"></div>
  </div>

  <div class="card">
    <strong>Gal√©ria</strong>
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
  // 1) Izba z URL
  const params = new URLSearchParams(location.search);
  const room = params.get('room') || 'UNKNOWN';
  document.getElementById('roomName').textContent = room;

  // 2) DOPL≈á SVOJU Apps Script URL (bod 2 ‚Äì nasaden√Ω WebApp /exec)
  const PHOTOS_API = 'https://script.google.com/macros/s/AKfycbwg9D3PTS3q2xAlMoPJtP9yNy_n3NFarYc76AN4N_fertWiGTE5p3awR9WBuqGvtDFg/exec';

  const msg = (t, cls='') => {
    const el = document.getElementById('msg');
    el.className = 'muted ' + cls;
    el.textContent = t || '';
  };

  // prehodenie file -> base64
  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);     // data:<mime>;base64,XXXX
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  // jednoduch√° kompresia (max dlh≈°ia strana = 2000 px)
  async function resizeIfNeeded(dataUrl, maxDim=2000){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const w = img.width, h = img.height;
        const scale = Math.min(1, maxDim/Math.max(w,h));
        if(scale === 1){ return resolve(dataUrl); }
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(w*scale);
        canvas.height = Math.round(h*scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.9));
      };
      img.src = dataUrl;
    });
  }

  function addThumb(url){
    const grid = document.getElementById('grid');
    const div = document.createElement('div');
    div.className = 'thumb';
    div.innerHTML = `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt=""></a>`;
    grid.prepend(div);
  }

  async function upload(){
    const file = document.getElementById('photo').files[0];
    const wall = document.getElementById('wall').value.trim();
    if(!file){ msg('Vyber fotku‚Ä¶', 'err'); return; }

    msg('Sprac√∫vam fotku‚Ä¶');
    let b64 = await fileToBase64(file);
    b64 = await resizeIfNeeded(b64, 2000); // zmen≈°√≠ ak je veƒæk√°

    msg('Nahr√°vam do cloudu‚Ä¶');
    try{
      const resp = await fetch(PHOTOS_API, {
        method: 'POST',
        body: JSON.stringify({
          room,
          wall,
          imageBase64: b64,
          mimeType: 'image/jpeg',
          filename: `${room}_${wall || 'WALL'}_${Date.now()}.jpg`
        })
      });
      const j = await resp.json();
      if(!j.ok){ throw new Error(j.error || 'Upload zlyhal'); }
      msg('‚úÖ Ulo≈æen√©: ' + (j.filename||''), 'ok');
      addThumb(j.url); // rovno uk√°≈æeme v gal√©rii
      document.getElementById('photo').value = '';
    }catch(e){
      console.error(e);
      msg('‚ùå Nepodarilo sa nahra≈•: ' + e.message, 'err');
    }
  }

  document.getElementById('uploadBtn').onclick = async () => {
  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];
  if (!file) return alert('Vyber s√∫bor');

  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result.split(',')[1];

    const payload = new URLSearchParams();
    payload.append("file", base64);
    payload.append("name", file.name);
    payload.append("type", file.type);

    const res = await fetch("https://script.google.com/macros/s/XXX/exec", {
      method: "POST",
      body: payload
    });
    const data = await res.json();

    if (data.ok) {
      alert("‚úÖ Nahrat√©: " + data.url);
    } else {
      alert("‚ùå Chyba: " + data.error);
    }
  };
  reader.readAsDataURL(file);
};

</script>
</body>
</html>


