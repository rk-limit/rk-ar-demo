<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>To-Do list</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0d12; color:#e8ecf4; margin:0; padding:20px; }
    h1 { font-size:20px; margin:0 0 10px }
    ul { list-style:none; padding:0; margin:0 }
    li { background:#121521; border:1px solid #1e2230; border-radius:10px; margin:8px 0; padding:12px;
         display:flex; align-items:center; gap:10px }
    li.done { background:#15331c; border-color:#255e30 }
    label { flex:1; cursor:pointer }
    .pill{background:#1e2a44;border:1px solid #2d3e63;border-radius:999px;padding:2px 8px;font-size:12px;color:#cde1ff}
    .msg{margin-top:12px;font-size:13px;opacity:.8}
  </style>
</head>
<body>
  <h1>√ölohy ‚Äì <span id="roomName"></span></h1>
  <ul id="todoList"></ul>
  <div class="msg" id="msg"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const room = params.get('room') || 'UNKNOWN';
    document.getElementById('roomName').textContent = room;

    // üîó DOPL≈á svoju Apps Script URL (konƒçiacu na /exec)
    const SHEET_API = "PASTE_YOUR_WEB_APP_URL_HERE";

    const msg = (t)=>document.getElementById('msg').textContent=t;

    // naƒç√≠taj zoznam obvodov pre dan√∫ izbu
    fetch(`${room}.json`)
      .then(r=>r.json())
      .then(data=>{
        const listEl = document.getElementById('todoList');
        const saved = JSON.parse(localStorage.getItem('todo-'+room) || '{}');

        data.obvody.forEach(obvod=>{
          const li = document.createElement('li');
          if(saved[obvod.kod]) li.classList.add('done');

          const chk = document.createElement('input');
          chk.type='checkbox';
          chk.checked = !!saved[obvod.kod];

          const code = document.createElement('span');
          code.className='pill';
          code.textContent = obvod.kod;

          const label = document.createElement('label');
          label.textContent = obvod.nazov;

          // klik ‚Üí ulo≈æi≈• lok√°lne + posla≈• do Sheets
          chk.onchange = async ()=>{
            const status = chk.checked ? 'hotovo' : 'odznacene';
            // lok√°lne
            saved[obvod.kod] = chk.checked;
            localStorage.setItem('todo-'+room, JSON.stringify(saved));
            li.classList.toggle('done', chk.checked);

            // cloud z√°pis
            try{
              msg('Uklad√°m‚Ä¶');
              const res = await fetch(SHEET_API, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                  room,
                  circuit: obvod.kod,
                  label: obvod.nazov,
                  status
                })
              });
              if(!res.ok) throw new Error('HTTP '+res.status);
              msg('Ulo≈æen√©.');
              setTimeout(()=>msg(''), 1200);
            }catch(e){
              console.warn(e);
              msg('Nepodarilo sa ulo≈æi≈• do cloudu (internet?). Sk√∫s nesk√¥r.');
            }
          };

          li.append(chk, code, label);
          listEl.append(li);
        });
      })
      .catch(()=>msg('Nena≈°iel som JSON pre t√∫to izbu.'));
  </script>
</body>
</html>
